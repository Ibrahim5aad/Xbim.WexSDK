@page "/"
@page "/xbim-viewer"
@using Xbim.WexBlazor.Components
@using Xbim.WexBlazor.Components.BuiltInButtons
@using Xbim.WexBlazor.Interop
@using Xbim.WexBlazor.Models
@using Xbim.WexBlazor.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http
@implements IDisposable
@inject IJSRuntime JSRuntime
@inject ThemeService ThemeService
@inject IfcModelService IfcModelService
@inject PropertyService PropertyService

<PageTitle>Xbim Viewer</PageTitle>


<XbimViewerComponent @ref="_xbimViewer"
                     Id="xbimViewer"
                     Width="100%"
                     Height="600"
                     BackgroundColor="@ThemeService.CurrentBackgroundColor"
                     ContainerStyle="width: 100%; height: 100%; position: relative;"
                     OnViewerInitialized="HandleViewerInitialized"
                     OnModelLoaded="HandleModelLoaded"
                     OnLoaded="HandleLoaded"
                     OnPick="HandlePick"
                     OnHoverPick="HandleHoverPick"
                     OnClick="HandleClick">

        <FileLoaderPanel 
                         IsVisible="@_showFileLoader"
                         AllowClose="true"
                         DemoModels="@_demoModels"
                         OnFileLoaded="HandleFileDataLoaded"
                         OnUrlLoaded="HandleUrlModelLoad"
                         OnClose="HandleLoaderClose"
                         OnError="HandleLoaderError" />

        @if (_xbimViewer != null)
        {
            <ModelManagerPanel IsVisible="@_showModelManager"
                               Viewer="@_xbimViewer"
                               Models="@GetLoadedModelsList()"
                               Position="ModelManagerPosition.TopRight"
                               AllowClose="true"
                               ShowActions="true"
                               OnClose="HandleModelManagerClose"
                               OnLoadModel="ShowFileLoader"
                               OnAfterToggleVisibility="HandleAfterToggleModel"
                               OnAfterUnload="HandleAfterUnloadModel"
                               OnAfterUnloadAll="HandleAfterUnloadAllModels" />

            <ViewerToolbar Items="@_toolbarItems"
                           Position="@_toolbarPosition"
                           Alignment="@_toolbarAlignment" />

            <ViewerSidebar Position="SidebarPosition.Left">
                    <SidebarPanel Icon="bi-info-circle" Title="Properties" @bind-IsOpen="_showPropertiesPanel" Width="320">
                        <PropertiesPanel 
                            IsVisible="true"
                            Properties="@_currentProperties"
                            IsLoading="@_isLoadingProperties"
                            ShowHeader="false" />
                    </SidebarPanel>
                    <SidebarPanel Icon="bi-diagram-3" Title="Hierarchy" @bind-IsOpen="_showHierarchyPanel" Width="300">
                        <ModelHierarchyPanel 
                            IsVisible="true"
                            ProductTypes="@_productTypes"
                            SpatialStructure="@_spatialStructure"
                            HasSpatialData="@(_spatialStructure != null)"
                            IsLoading="@_isLoadingHierarchy"
                            SelectedProducts="@_selectedProductSet"
                            GetModelNameFunc="@GetModelName"
                            ShowHeader="false"
                            OnRefresh="RefreshHierarchy"
                            OnProductSelected="HandleHierarchyProductSelected" />
                    </SidebarPanel>
            </ViewerSidebar>
        }

</XbimViewerComponent>

@code {
    private XbimViewerComponent? _xbimViewer;
    private bool _showFileLoader = true;
    private bool _showModelManager = true;
    private bool _showPropertiesPanel = false;
    private bool _showHierarchyPanel = false;
    private List<SelectedElement> _selectedElements = new();
    private ElementProperties? _currentProperties;
    private bool _isLoadingProperties = false;
    
    private List<ProductTypeInfo> _productTypes = new();
    private HierarchyNode? _spatialStructure;
    private bool _isLoadingHierarchy = false;
    private HashSet<(int ProductId, int ModelId)> _selectedProductSet = new();
    private IfcHierarchyService _hierarchyService = new();
    
    // Plugin tracking
    private bool _gridActive = false;
    private bool _interactivePluginsInitialized = false;
    private SectionBoxPlugin? _sectionBoxPlugin;
    private GridPlugin? _gridPlugin;
    private ClippingPlanePlugin? _clippingPlanePlugin;

    private List<LoadedModel> GetLoadedModelsList()
    {
        return _xbimViewer?.GetLoadedModels().Values.ToList() ?? new List<LoadedModel>();
    }
    
    private List<ToolbarItemBase> _toolbarItems = new();
    private ToolbarPosition _toolbarPosition = ToolbarPosition.Bottom;
    private ToolbarAlignment _toolbarAlignment = ToolbarAlignment.Center;
    private ToolbarButton? _themeButton;
    
    private List<DemoModel> _demoModels = new()
    {
        new DemoModel
        {
            Name = "Four Walls",
            Path = "models/FourWalls.wexbim",
            Description = "A simple building model with four walls"
        },
        new DemoModel
        {
            Name = "Sample House",
            Path = "models/SampleHouse.ifc",
            Description = "A sample house model"
        }
    };
    
    protected override void OnInitialized()
    {
        ThemeService.OnThemeChanged += ApplyTheme;
        base.OnInitialized();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ApplyThemeAsync();
        }
        await base.OnAfterRenderAsync(firstRender);
    }
    
    private void ApplyTheme()
    {
        if (_themeButton != null)
        {
            _themeButton.Icon = GetThemeIcon();
        }
        InvokeAsync(ApplyThemeAsync);
    }
    
    private async Task ApplyThemeAsync()
    {
        await ThemeService.ApplyAsync(JSRuntime);
        
        if (_xbimViewer != null)
        {
            await ThemeService.ApplyToViewerAsync(_xbimViewer, _gridActive ? _gridPlugin : null);
        }
        
        StateHasChanged();
    }
    
    private async Task HandleViewerInitialized(string viewerId)
    {
        InitializeToolbar();
        
        if (_xbimViewer != null)
        {
            await ThemeService.ApplyToViewerAsync(_xbimViewer);
        }
        
        var navigationCubePlugin = new NavigationCubePlugin()
        {
            Ratio = 0.02,
            PassiveAlpha = 1,
            ActiveAlpha = 1
        };
        await _xbimViewer!.AddPluginAsync(navigationCubePlugin);
        
        _gridPlugin = new GridPlugin
        {
            Factor = 1.5,
            ZFactor = 20,
            NumberOfLines = 20,
            Color = ThemeService.CurrentGridColor
        };
        await _xbimViewer!.AddPluginAsync(_gridPlugin);
        _gridActive = true;
        
        await InvokeAsync(StateHasChanged);
    }
    
    private void InitializeToolbar()
    {
        if (_xbimViewer == null) return;
        
        _themeButton = new ToolbarButton
        {
            Icon = GetThemeIcon(),
            Tooltip = "Toggle Theme",
            OnClick = EventCallback.Factory.Create(this, ToggleTheme)
        };
        
        _toolbarItems = new List<ToolbarItemBase>
        {
            ViewerBuiltInButtons.CreatePerspectiveToggle(_xbimViewer, startWithPerspective: true),
            ViewerBuiltInButtons.CreateZoomFitButton(_xbimViewer),
            ViewerBuiltInButtons.CreateResetViewButton(_xbimViewer),
            ViewerBuiltInButtons.CreateViewsDropdown(_xbimViewer),
            ViewerBuiltInButtons.CreateNavigationButtons(_xbimViewer),
            ViewerBuiltInButtons.CreateXRayToggle(_xbimViewer),
            ViewerBuiltInButtons.CreateHideToggle(_xbimViewer, GetSelectedElementIds, StateHasChanged),
            ViewerBuiltInButtons.CreateIsolateToggle(_xbimViewer, GetSelectedElementIds, StateHasChanged),
            new ToolbarButton
            {
                Icon = "bi bi-x-circle",
                Tooltip = "Clear Selection",
                OnClick = EventCallback.Factory.Create(this, async () =>
                {
                    if (_xbimViewer != null)
                    {
                        await _xbimViewer.ClearSelectionAsync();
                        _currentProperties = null;
                        StateHasChanged();
                    }
                })
            },
            ViewerBuiltInButtons.CreateSectionBoxButtons(_xbimViewer, () => _sectionBoxPlugin, "Box", StateHasChanged),
            ViewerBuiltInButtons.CreateClippingPlaneButtons(_xbimViewer, () => _clippingPlanePlugin, "Plane", StateHasChanged),
            _themeButton
        };
    }
    
    private string GetThemeIcon()
    {
        return ThemeService.CurrentTheme == ViewerTheme.Light 
            ? "bi-sun" 
            : "bi-moon-stars";
    }

    private int[] GetSelectedElementIds()
    {
        return _selectedElements.Select(e => e.Id).ToArray();
    }
    
    private async Task ToggleTheme()
    {
        ThemeService.ToggleTheme();
        await Task.CompletedTask;
    }
    
    private async Task HandleModelLoaded(bool success)
    {
        if (success)
        {
            // Initialize interactive plugins after first model load (they need geometry)
            if (!_interactivePluginsInitialized && _xbimViewer != null)
            {
                _sectionBoxPlugin = new SectionBoxPlugin
                {
                    IsStopped = true
                };
                await _xbimViewer.AddPluginAsync(_sectionBoxPlugin);
                
                _clippingPlanePlugin = new ClippingPlanePlugin
                {
                    IsStopped = true
                };
                await _xbimViewer.AddPluginAsync(_clippingPlanePlugin);
                
                _interactivePluginsInitialized = true;
            }
            
            await ZoomFit();
        }
        await InvokeAsync(StateHasChanged);
    }
    
    private void ShowFileLoader()
    {
        _showFileLoader = true;
        StateHasChanged();
    }

    private void HandleLoaderClose()
    {
        _showFileLoader = false;
        StateHasChanged();
    }

    private async Task HandleFileDataLoaded(FileLoadedEventArgs args)
    {
        if (_xbimViewer == null) return;

        try
        {
            if (args.Format == ModelFormat.Ifc || args.Format == ModelFormat.IfcZip)
            {
                await Task.Yield();
                
                var progress = new Progress<IfcProcessingProgress>(p =>
                {
                    Console.WriteLine($"{p.Stage}: {p.Message} ({p.PercentComplete}%)");
                    InvokeAsync(StateHasChanged);
                });

                var result = await Task.Run(async () => 
                    await IfcModelService.ProcessIfcBytesAsync(args.FileData, args.FileName, progress));

                if (!result.Success || result.WexbimData == null)
                {
                    await HandleLoaderError(result.ErrorMessage ?? "Failed to process IFC file");
                    return;
                }

                // Load the generated wexbim into the viewer
                var loadedModel = await _xbimViewer.LoadModelFromBytesAsync(
                    result.WexbimData,
                    Path.ChangeExtension(args.FileName, ".wexbim"));

                if (loadedModel != null)
                {
                    loadedModel.SizeBytes = result.WexbimData.Length;
                    loadedModel.OriginalFormat = args.Format;
                    
                    // Store the IFC model reference for property access
                    if (result.Model != null)
                    {
                        loadedModel.IfcModel = result.Model;
                        
                        // Register property source for this model
                        var propertySource = new IfcPropertySource(result.Model, loadedModel.Id);
                        PropertyService.RegisterSource(propertySource);
                    }
                    
                    _showFileLoader = false;
                    StateHasChanged();
                }
            }
            else
            {
                // Load wexbim file directly
                var loadedModel = await _xbimViewer.LoadModelFromBytesAsync(args.FileData, args.FileName);
                if (loadedModel != null)
                {
                    loadedModel.SizeBytes = args.FileSize;
                    loadedModel.OriginalFormat = args.Format;
                    _showFileLoader = false;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading file: {ex.Message}");
            await HandleLoaderError($"Error loading file: {ex.Message}");
        }
    }

    private async Task HandleUrlModelLoad(string url)
    {
        if (_xbimViewer == null) return;

        try
        {
            var lowerUrl = url.ToLowerInvariant();
            
            if (lowerUrl.EndsWith(".ifc") || lowerUrl.EndsWith(".ifczip"))
            {
                var fileName = Path.GetFileName(new Uri(url).LocalPath);
                
                using var httpClient = new HttpClient();
                httpClient.Timeout = TimeSpan.FromMinutes(5);
                
                var fileData = await httpClient.GetByteArrayAsync(url);
                
                await Task.Yield();
                
                var progress = new Progress<IfcProcessingProgress>(p =>
                {
                    Console.WriteLine($"{p.Stage}: {p.Message} ({p.PercentComplete}%)");
                    InvokeAsync(StateHasChanged);
                });

                var result = await Task.Run(async () => 
                    await IfcModelService.ProcessIfcBytesAsync(fileData, fileName, progress));
                
                if (!result.Success)
                {
                    Console.WriteLine($"IFC processing failed: {result.ErrorMessage}");
                    return;
                }
                
                if (result.WexbimData != null)
                {
                    var loadedModel = await _xbimViewer.LoadModelFromBytesAsync(result.WexbimData, fileName);
                    if (loadedModel != null)
                    {
                        loadedModel.IfcModel = result.Model;
                        loadedModel.OriginalFormat = ModelFormat.Ifc;
                        
                        if (result.Model != null)
                        {
                            var propertySource = new IfcPropertySource(result.Model, loadedModel.Id, fileName);
                            PropertyService.RegisterSource(propertySource);
                        }
                        
                        _showFileLoader = false;    
                        StateHasChanged();
                        await RefreshHierarchy();
                    }
                }
            }
            else
            {
                var loadedModel = await _xbimViewer.LoadModelAsync(url);
                if (loadedModel != null)
                {
                    _showFileLoader = false;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from URL: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private async Task HandleLoaderError(string error)
    {
        Console.WriteLine($"Loader error: {error}");
        // You might want to show a toast notification here
        await Task.CompletedTask;
    }

    // Model Manager handlers
    private void HandleModelManagerClose()
    {
        _showModelManager = false;
        StateHasChanged();
    }

    private async Task HandleAfterToggleModel(LoadedModel model)
    {
        await ZoomFit();
        StateHasChanged();
    }

    private async Task HandleAfterUnloadModel(LoadedModel model)
    {
        await ZoomFit();
        StateHasChanged();
    }

    private async Task HandleAfterUnloadAllModels()
    {
        await ZoomFit();
        StateHasChanged();
    }
    
    private async Task ZoomFit()
    {
        if (_xbimViewer != null)
        {
            await _xbimViewer.ZoomFitAsync();
        }
    }
    
    private async Task Reset()
    {
        if (_xbimViewer != null)
        {
            await _xbimViewer.ResetAsync();
        }
    }
    
    private async Task GetSelection()
    {
        if (_xbimViewer != null)
        {
            var selected = await _xbimViewer.GetSelectedElementsAsync();
            _selectedElements = selected.ToList();
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task HandlePick(ViewerEventArgs e)
    {
        if (e.Id.HasValue && _xbimViewer != null)
        {
            var isHighlighted = await _xbimViewer.IsElementHighlightedAsync(e.Id.Value, e.Model);
            
            if (isHighlighted)
            {
                await _xbimViewer.UnhighlightElementsAsync(new[] { e.Id.Value }, e.Model);
                // Clear properties when deselecting
                _currentProperties = null;
            }
            else
            {
                await _xbimViewer.HighlightElementsAsync(new[] { e.Id.Value }, e.Model);
                // Load properties for the selected element
                if (e.Model.HasValue)
                {
                    await LoadPropertiesForElement(e.Id.Value, e.Model.Value);
                }
            }
            
            await GetSelection();
        }
        
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task LoadPropertiesForElement(int elementId, int modelId)
    {
        if (PropertyService == null) return;
        
        try
        {
            _isLoadingProperties = true;
            StateHasChanged();
            
            // Get properties from all registered sources
            var properties = await PropertyService.GetPropertiesAsync(elementId, modelId);
            
            _currentProperties = properties;
            
            // Show properties panel if it's hidden
            if (properties != null && !_showPropertiesPanel)
            {
                _showPropertiesPanel = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading properties: {ex.Message}");
            _currentProperties = null;
        }
        finally
        {
            _isLoadingProperties = false;
            StateHasChanged();
        }
    }
    
    
    private async Task HandleHoverPick(ViewerEventArgs e)
    {
        if (e.Id.HasValue)
        {
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task HandleClick(ViewerEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleLoaded(ViewerEventArgs e)
    {
        if (_xbimViewer != null)
        {
            await _xbimViewer.ShowAsync(ViewerConstants.ViewType.Top);
        }
    }

    private async Task RefreshHierarchy()
    {
        if (_xbimViewer == null) return;
        
        _isLoadingHierarchy = true;
        StateHasChanged();
        
        try
        {
            _productTypes = await _xbimViewer.GetProductTypesAsync();
            
            var models = _xbimViewer.GetLoadedModels();
            foreach (var model in models.Values)
            {
                if (model.IfcModel != null)
                {
                    _spatialStructure = _hierarchyService.GetSpatialStructure(model.IfcModel, model.Id);
                    break;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading hierarchy: {ex.Message}");
        }
        finally
        {
            _isLoadingHierarchy = false;
            StateHasChanged();
        }
    }

    private async Task HandleHierarchyProductSelected((int ProductId, int ModelId) selection)
    {
        if (_xbimViewer == null) return;
        
        var isSelected = _selectedProductSet.Contains(selection);
        
        if (isSelected)
        {
            await _xbimViewer.UnhighlightElementsAsync(new[] { selection.ProductId }, selection.ModelId);
            _selectedProductSet.Remove(selection);
        }
        else
        {
            await _xbimViewer.HighlightElementsAsync(new[] { selection.ProductId }, selection.ModelId);
            _selectedProductSet.Add(selection);
            await LoadPropertiesForElement(selection.ProductId, selection.ModelId);
        }
        
        StateHasChanged();
    }

    private string GetModelName(int modelId)
    {
        var models = _xbimViewer?.GetLoadedModels();
        if (models != null && models.TryGetValue(modelId, out var model))
        {
            return model.Name;
        }
        return $"Model {modelId}";
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= ApplyTheme;
    }
}
